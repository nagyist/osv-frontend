
<!DOCTYPE html>
<html lang="en">
    <head>
        <title>OpenStreetView.io - The free and collaborative 360째 street view of the world</title>
        <meta name="description" content="Welcome to the most adventurous motorcycle tour of New Zealand. Experience 8 days deep in the bush, crossing rivers and riding on top of mountains." />
        <meta name="description" content="The free and collaborative 360째 street view of the world. Openly licensed and created by volunteers. Run as non-profit." />
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

        <link rel="stylesheet" href="lib/bootstrap/css/theme/bootstrap.min.css">
        <link rel="stylesheet" href="lib/openlayers/ol.css">

        <style>
            body {
                margin: 0px;
            }

            header.navbar {
              margin-bottom: 0px;
            }

            #demo {
              margin-left: 0px;
              margin-right: 0px;  
            }

            #demo .col-md-6 {
              padding-left: 0px;
              padding-right: 0px;
            }

            #demo #map {
              height: 500px;
            }

            #demo #openstreetview {
                font-size: 0px;
            }

            #wall1 {
                background-color: #2487C1;
                padding: 30px 0px;
                font-size: 20px;
                color: white;
            }

        </style>

        <script src="lib/jquery/jquery-2.1.4.min.js"></script>
        <script src="lib/bootstrap/js/bootstrap.min.js"></script>
        <script src="lib/threejs/three.min.js"></script>
        <script src="lib/openlayers/ol.js"></script>
        <script src="js/openstreetview.js"></script>
    </head>
    <body>


        <header class="navbar navbar-default navbar-static-top navbar-inverse" role="navigation">
          <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
              <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="#">OpenStreetView.io</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">

              <ul class="nav navbar-nav navbar-right">
                <li><p class="navbar-text text-sm"><span class="glyphicon glyphicon-camera" aria-hidden="true"></span> Currently ~1 km mapped!</p></li>
                <li><a href="#">Login (coming soon)</a></li>
              </ul>
            </div><!-- /.navbar-collapse -->
          </div><!-- /.container-fluid -->
        </header>


        <div id="demo" class="row">
            <div class="col-md-6">
                <div id="map"></div>
            </div>

            <div class="col-md-6">
                <div id="openstreetview"></div>
            </div>
        </div>

        
        <div id="wall1" class="row">
            <div class="col-md-6 col-md-offset-3">
                The free and collaborative 360째 street view of the world
            </div>
        </div>
        
        <div class="row" style="margin: 30px 0px">
          <div class="col-md-6 col-md-offset-3" style="font-size:16px">
            <p>360째 camera are getting mainstream and affordable. Time to start OpenStreetView!<p>
            <a href="https://github.com/nand2/osv-frontend">Project</a> just starting! (January 2016). Fully Open Source, non-profit. Plan : 
            <ul>
              <li>End January 2016: Working navigation widget, integrated with OpenStreetMap (via OpenLayers)</li>
              <li>End February 2016: Ready to take user contributions</li>
              <li>End March 2016: Part of Paris being mapped on top of other contributions</li>
            </ul>
          </div>
        </div>

        <script>
          var style = new ol.style.Style({
            stroke: new ol.style.Stroke({
              color: [0, 0, 255, 0.5],
              width: 5
            })
          });

          // var vectorSource = new ol.source.Vector({
          //     url: 'osv.geojson',
          //     format: new ol.format.GeoJSON()
          //   });

          var geoJSONFormat = new ol.format.GeoJSON();
          var vectorSource = new ol.source.Vector({
            format: new ol.format.GeoJSON(),
            url: function(extent, resolution, projection) {
              return 'osv.geojson?bbox=' + extent.join(',') + ',EPSG:3857';
            },
            strategy: ol.loadingstrategy.bbox
          });
          vectorSource.on('change', function() {
            // Send all the picture data to the OpenStreetView instance
            vectorSource.forEachFeature(function(feature) {
              osvData = feature.get("openstreetview");
              if(osvData) {
                for(var i = 0; i < osvData.pics.length; i++) {
                  osv.addPicture(osvData.pics[i]);
                }
              }
            });
          });

          var osvLayer = new ol.layer.Vector({
            source: vectorSource,
            style: style
          });

          var map = new ol.Map({
            layers: [
              new ol.layer.Tile({
                source: new ol.source.MapQuest({layer: 'osm'})
              }),
              osvLayer
            ],
            target: 'map',
            controls: ol.control.defaults({
              attributionOptions: /** @type {olx.control.AttributionOptions} */ ({
                collapsible: false
              })
            }),
            view: new ol.View({
              maxZoom: 19,
              center: ol.proj.fromLonLat([2.309241, 48.88711]),
              zoom: 19
            })
          });


          // Basic distance between points, incorrect in long lengths (projection etc)
          var distanceBetweenPoints = function(latlng1, latlng2){
              var line = new ol.geom.LineString([latlng1, latlng2]);
              return Math.round(line.getLength() * 100) / 100;
          };

          // On click on the map, display the closest available pic
          map.on('click', function(evt) {
            displayPicSnap(evt.coordinate);
          });

          var debug = true;
          var debugClosestGeometryLine = null;
          var debugClosestGeometryPoint = null;
          var debugClosestPointLine = null;
          var debugClosestPointPoint = null;
          var displayPicSnap = function(coordinate) {
            // Get the closest line of pics
            var closestFeature = vectorSource.getClosestFeatureToCoordinate(coordinate);
            if (closestFeature != null) {
              // Get the closest point in the line of pics
              var geometry = closestFeature.getGeometry();
              var closestGeometryPoint = geometry.getClosestPoint(coordinate);

              // Get the closest actual pic on the line of pics
              var coordinates = geometry.getCoordinates();
              var closestCoordinateId = 0;
              var minDistance = distanceBetweenPoints(closestGeometryPoint, coordinates[0]);
              for(var i = 1; i < coordinates.length; i++) {
                var distance = distanceBetweenPoints(closestGeometryPoint, coordinates[i]);
                if(distance < minDistance) {
                    closestCoordinateId = i;
                    minDistance = distance;
                }
              }
              var closestGeometryCoordinate = coordinates[closestCoordinateId];
              var picsData = closestFeature.get("openstreetview")['pics'];
              var picData = picsData[closestCoordinateId];
              // Ask the OpenStreetView instance to display this picture
              console.log(closestCoordinateId);
              osv.showPicture(picData.id);
              


              if(debug) {
                if (debugClosestGeometryPoint === null) {
                  debugClosestGeometryPoint = new ol.geom.Point(closestGeometryPoint);
                } else {
                  debugClosestGeometryPoint.setCoordinates(closestGeometryPoint);
                }
                var coordinates = [coordinate, [closestGeometryPoint[0], closestGeometryPoint[1]]];
                if (debugClosestGeometryLine === null) {
                  debugClosestGeometryLine = new ol.geom.LineString(coordinates);
                } else {
                  debugClosestGeometryLine.setCoordinates(coordinates);
                }

                if (debugClosestPointPoint === null) {
                  debugClosestPointPoint = new ol.geom.Point(closestGeometryCoordinate);
                } else {
                  debugClosestPointPoint.setCoordinates(closestGeometryCoordinate);
                }
                var debugLineCoordinates = [closestGeometryPoint, closestGeometryCoordinate];
                if (debugClosestPointLine === null) {
                  debugClosestPointLine = new ol.geom.LineString(debugLineCoordinates);
                } else {
                  debugClosestPointLine.setCoordinates(debugLineCoordinates);
                }
              }
            }
            map.render();
          };

          if(debug) {
            var imageStyle = new ol.style.Circle({
              radius: 5,
              fill: null,
              stroke: new ol.style.Stroke({
                color: 'rgba(255,0,0,0.9)',
                width: 1
              })
            });
            var strokeStyle = new ol.style.Stroke({
              color: 'rgba(255,0,0,0.9)',
              width: 1
            });
            map.on('postcompose', function(evt) {
              var vectorContext = evt.vectorContext;
              if (debugClosestGeometryPoint !== null) {
                vectorContext.setImageStyle(imageStyle);
                vectorContext.drawPointGeometry(debugClosestGeometryPoint);
              }
              if (debugClosestGeometryLine !== null) {
                vectorContext.setFillStrokeStyle(null, strokeStyle);
                vectorContext.drawLineStringGeometry(debugClosestGeometryLine);
              }
              if (debugClosestPointPoint !== null) {
                vectorContext.setImageStyle(imageStyle);
                vectorContext.drawPointGeometry(debugClosestPointPoint);
              }
              if (debugClosestPointLine !== null) {
                vectorContext.setFillStrokeStyle(null, strokeStyle);
                vectorContext.drawLineStringGeometry(debugClosestPointLine);
              }
            });            
          }

        </script>

        <script>
          var osv = new OpenStreetView({
            width: window.innerWidth / 2,
            height: 500
          });
        </script>


    </body>
</html>
